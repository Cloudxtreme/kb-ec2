## Setup

- machine t2.medium (2 CPU cores, 4GB)

- KB 0.12.1
- patched Stripe 0.2.1.10 plugin (branch load_testing15 with pool: false)
  includes LRU cache updated (v2)
  
```
### KB: concurrency connection pool size (default 30) :
JAVA_OPTS="${JAVA_OPTS} -Dorg.killbill.dao.maxActive=80"

# TODO NEXT :
#JAVA_OPTS="${JAVA_OPTS} -Dorg.killbill.dao.connectionTimeout=5s"

JAVA_OPTS="${JAVA_OPTS} -Dorg.killbill.billing.osgi.dao.maxActive=50"
JAVA_OPTS="${JAVA_OPTS} -Dorg.killbill.billing.osgi.dao.connectionTimeout=5s"

JAVA_OPTS="${JAVA_OPTS} -Dorg.killbill.payment.plugin.threads.nb=80"
```

- (**WITH** org.killbill.persistent.bus configuration)

- updated Tomcat configuration :
```xml
    <Connector port="8080" protocol="HTTP/1.1"
               URIEncoding="UTF-8"
               redirectPort="8443"
               maxThreads="200"
               acceptCount="50"
               acceptorThreadCount="2"
               connectionTimeout="10000"
               keepAliveTimeout="5000"
               maxKeepAliveRequests="100" />
```

- updated JVM settings :
```
JAVA_OPTS="-Djava.awt.headless=true"
if [ "${1}" = "start" ]; then
  JAVA_OPTS="${JAVA_OPTS} -XX:+UseConcMarkSweepGC -XX:+UseCodeCacheFlushing"
  JAVA_OPTS="${JAVA_OPTS} -Xms1024m -Xmx1792m -XX:PermSize=128m -XX:MaxPermSize=256m"
fi


### KB: tuning
JAVA_OPTS="${JAVA_OPTS} -XX:CompileThreshold=7000"

### KB: remote monitoring
if [ "${1}" = "start" ]; then
  JAVA_OPTS="${JAVA_OPTS} -Dcom.sun.management.jmxremote"
  JAVA_OPTS="${JAVA_OPTS} -Dcom.sun.management.jmxremote.port=9901"
  JAVA_OPTS="${JAVA_OPTS} -Dcom.sun.management.jmxremote.authenticate=false"
  JAVA_OPTS="${JAVA_OPTS} -Dcom.sun.management.jmxremote.ssl=false"
fi

### KB: JRuby

JAVA_OPTS="${JAVA_OPTS} -Djruby.management.enabled=true"
JAVA_OPTS="${JAVA_OPTS} -Djruby.reify.classes=true"
#JAVA_OPTS="${JAVA_OPTS} -Djruby.reify.logErrors=true"

JAVA_OPTS="${JAVA_OPTS} -Djruby.compile.fastest=true"
```

- updated WEB-INF libraries:
  * **updated HikariCP-java6** to 2.3.2 (was 2.0.1)
  * removed bonecp-0.8.0-rc3.jar

- hit with **50** concurrency for 4 hours (doing stripe payments)

## Notes

* CPU activity 100% except for last 0.5h TODO
  
* JRuby BacktraceCount/ExceptionCount: 271.025

* TODO DB connection usage


## Results

|                                 | #count | average | median | 90% |  min |   max |   errors | bandwidth |
| ------------------------------- | ------ | ------- | ------ | --- | ---- | ----- | -------- | --------- |
|                         Threads |      2 |     863 |    252 |   0 |  252 |  1475 | 0.00000% |    0.02/s |
|                         Metrics |      5 |     127 |     73 |   0 |   46 |   373 | 0.00000% |    0.02/s |
|                  Create Account |     50 |    3090 |   3294 |   0 |  488 |  5571 | 0.00000% |    1.29/s |
|                   Visit Account |     50 |    2908 |   2997 |   0 |  358 |  5239 | 0.00000% |    1.81/s |
| Stripe (Default) Payment Method |     50 |    7838 |   7952 |   0 | 4795 | 12178 | 0.00000% |     1.1/s |
|               Authorize Payment |  20857 |   11380 |   6720 |   0 | 3253 | 50660 | 0.00034% |    1.28/s |
|                 Capture Payment |  20839 |   11730 |   6902 |   0 |    0 | 52550 | 0.00034% |    1.12/s |
|                Purchase Payment |  20822 |   11410 |   6745 |   0 | 3554 | 49186 | 0.00000% |    1.28/s |
|                           TOTAL |  62675 |   11489 |   6792 |   0 |    0 | 52550 | 0.00022% |    3.71/s |


## Logs

|                                                       | Count |
| ----------------------------------------------------- | ----- |
|                                                Errors |     6 |
|               java.util.concurrent.ExecutionException |     7 |
|  org.killbill.billing.payment.api.PaymentApiException |     7 |
|                                                 TOTAL |    20 |



2. java.util.concurrent.ExecutionException messages:

  org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.billing.payment.api.PaymentApiException: Plugin exception wrong number of arguments (1 for 2)
  org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.billing.payment.api.PaymentApiException: Plugin exception wrong number of arguments (1 for 2)
  org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.billing.payment.api.PaymentApiException: Plugin exception wrong number of arguments (1 for 2)
  org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.billing.payment.api.PaymentApiException: Plugin exception wrong number of arguments (1 for 2)
  org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.billing.payment.api.PaymentApiException: Plugin exception wrong number of arguments (1 for 2)
  org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.billing.payment.api.PaymentApiException: Plugin exception wrong number of arguments (1 for 2)
  org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.billing.payment.api.PaymentApiException: Plugin exception wrong number of arguments (1 for 2)


3. org.killbill.billing.payment.api.PaymentApiException messages:

  Internal payment error : org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.billing.payment.api.PaymentApiException: Plugin exception wrong number of arguments (1 for 2)
  Internal payment error : org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.billing.payment.api.PaymentApiException: Plugin exception wrong number of arguments (1 for 2)
  Internal payment error : org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.billing.payment.api.PaymentApiException: Plugin exception wrong number of arguments (1 for 2)
  Internal payment error : org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.billing.payment.api.PaymentApiException: Plugin exception wrong number of arguments (1 for 2)
  Internal payment error : org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.billing.payment.api.PaymentApiException: Plugin exception wrong number of arguments (1 for 2)
  Internal payment error : org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.billing.payment.api.PaymentApiException: Plugin exception wrong number of arguments (1 for 2)
  Internal payment error : org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.automaton.OperationException: {cause=null, code=7199, formattedMsg='Plugin exception wrong number of arguments (1 for 2)'}
    Caused by: org.killbill.billing.payment.api.PaymentApiException: Plugin exception wrong number of arguments (1 for 2)

